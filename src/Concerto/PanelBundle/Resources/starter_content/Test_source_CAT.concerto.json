{
    "version": "5.0.beta.3.0",
    "collection": [
        {
            "class_name": "Test",
            "id": 25,
            "name": "source_CAT",
            "accessibility": 2,
            "archived": "0",
            "visibility": 2,
            "type": 0,
            "code": "library(catR)\n\nif(is.null(template_def) || is.na(template_def) || template_def == \"\") {\n  decoded_template_def = fromJSON(concerto.var.get(\"template_def\"))\n} else {\n  decoded_template_def = fromJSON(template_def)\n}\n\ngetQuestions = function(){\n  questions = NULL\n  ib = fromJSON(item_bank)\n  if(ib$table_type == \"custom\") {\n    data_set_id = ib$data_set_id\n    table = ib$custom_table$table\n    question_column = ib$custom_table$columns$question\n    response_options_column = ib$custom_table$columns$response_options\n    a_column = ib$custom_table$columns$a\n    b_column = ib$custom_table$columns$b\n    c_column = ib$custom_table$columns$c\n    d_column = ib$custom_table$columns$d\n    correct_column = ib$custom_table$columns$correct\n    data_set_id_column = ib$custom_table$columns$data_set_id\n    cb_group_column = ib$custom_table$columns$cb_group\n    questions = concerto.table.query(\"SELECT id, `{{question_column}}` AS `question`, `{{response_options_column}}` AS `response_options`, `{{a_column}}` AS `a`, `{{b_column}}` AS `b`, `{{c_column}}` AS `c`, `{{d_column}}` AS `d`, `{{correct_column}}` AS `correct`, `{{cb_group_column}}` AS `cb_group` FROM `{{table}}` WHERE `{{data_set_id_column}}` = '{{data_set_id}}'\", list(\n      question_column=question_column,\n      response_options_column=response_options_column,\n      a_column=a_column,\n      b_column=b_column,\n      c_column=c_column,\n      d_column=d_column,\n      correct_column=correct_column,\n      cb_group_column=cb_group_column,\n      table=table,\n      data_set_id_column=data_set_id_column,\n      data_set_id=dbEscapeStrings(concerto$connection, toString(data_set_id))\n    ))\n  }\n  if(ib$table_type == \"direct\") {\n    if(length(ib$direct_table) > 0) {\n      for(i in 1:length(ib$direct_table)) {\n        ib$direct_table[[i]]$response_options = as.character(toJSON(ib$direct_table[[i]]$response_options)) #response options don't fit into flat table, so turn them back to JSON.\n        questions = rbind(questions, data.frame(ib$direct_table[[i]], stringsAsFactors=F))\n      }\n    }\n  }\n\n  if(dim(questions)[1] == 0) { stop(\"Item bank must not be empty!\") }\n  return(questions)\n}\n\ngetContent = function(question) {\n  o = question$response_options\n  if(is.character(o)) { o = fromJSON(o) }\n  response_type = \"open_text\"\n  options = NULL\n  section_classes = \"\"\n  section_styles = \"\"\n  \n  if(length(o) > 0) {\n    response_type = \"multiple_choice\"\n    if(randomize_response_options == \"1\") {\n      options = o[sample(1:length(o))]\n    } else {\n      options = o\n    }\n    section_classes = \"CAT-response-section-vertical\"\n    section_styles = \"\"\n    if(responses_layout == \"horizontal\") { \n      section_classes = \"CAT-response-section-horizontal\" \n      section_styles = paste0(\"width: \",response_width)\n    }\n  }\n  \n  content = concerto.template.join(templateId=CAT_template,params=list(\n    paragraph = paragraph,\n    question = question$question,\n    response_type = response_type,\n    response_options = toJSON(options),\n    section_classes = section_classes,\n    section_styles = section_styles\n  ))\n\n  return(content)\n}\n\nshouldStop = function(response, sem, out, questions) {\n  sr_time = fromJSON(stopping_time)\n  if(!is.null(sr_time$type) && sr_time$type == \"test\" && response$isTimeout == \"1\") { return(TRUE) }\n\n  sr_count = fromJSON(stopping_item_count)\n  if((sr_count$enabled == \"1\" && length(out) >= as.numeric(sr_count$count)) || length(out) >= dim(questions)[1]) { return(TRUE) }\n\n  sr_accuracy = fromJSON(stopping_accuracy)\n  if(sr_accuracy$enabled == \"1\" && as.numeric(sr_accuracy$accuracy) >= sem ) { return(TRUE) }\n  return(FALSE)\n}\n\nsaveResponse = function(response, question, rb, theta, sem, correct) {\n  table = \"default_cat_response_table\"\n  item_id_column = \"item_id\"\n  response_column = \"response\"\n  time_taken_column = \"time_taken\"\n  session_id_column = \"session_id\"\n  correct_column = \"correct\"\n  theta_column = \"theta\"\n  sem_column = \"sem\"\n  data_set_id_column = \"data_set_id\"\n  data_set_id = rb$data_set_id\n  if(rb$table_type == \"custom\") {\n    table = rb$custom_table$table\n    item_id_column = rb$custom_table$columns$item_id\n    response_column = rb$custom_table$columns$response\n    time_taken_column = rb$custom_table$columns$time_taken\n    session_id_column = rb$custom_table$columns$session_id\n    correct_column = rb$custom_table$columns$correct\n    theta_column = rb$custom_table$columns$theta\n    sem_column = rb$custom_table$columns$sem\n    data_set_id_column = rb$custom_table$columns$data_set_id\n  }\n  session_id = 0\n  if(!is.null(session) && is.list(session)) {\n    session_id = session$id\n  } else {\n    session_id = paste0(\"i\",concerto$session$id)\n  }\n\n  concerto.table.query(\"INSERT INTO `{{table}}` SET `{{item_id_column}}`={{item_id}}, `{{response_column}}`='{{response}}', `{{time_taken_column}}`={{time_taken}}, `{{session_id_column}}`='{{session_id}}', `{{correct_column}}`={{correct}}, `{{theta_column}}`={{theta}}, `{{sem_column}}`={{sem}}, `{{data_set_id_column}}`='{{data_set_id}}'\", list(\n    table=table,\n    session_id_column=session_id_column,\n    session_id=session_id,\n    item_id_column=item_id_column,\n    item_id=question$id,\n    response_column=response_column,\n    response=response$response,\n    time_taken_column=time_taken_column,\n    time_taken=response$timeTaken,\n    correct_column=correct_column,\n    correct=correct,\n    theta_column=theta_column,\n    theta=theta,\n    sem_column=sem_column,\n    sem=sem,\n    data_set_id_column=data_set_id_column,\n    data_set_id=dbEscapeStrings(concerto$connection, toString(data_set_id))\n  ))\n}\n\ngetTemplateParams = function(template_params){\n  params = list()\n  if(!is.null(inserts) && is.list(inserts)) {\n    params = inserts\n  }\n  for(key in ls(template_params)) {\n    params[[key]] = template_params[[key]]\n  }\n  return(params)\n}\n\ngetNextDebugItem = function(response, questions) {\n  for(i in 1:dim(questions)[1]) {\n    question = questions[i,]\n    if(question$id == response$item_debug) {\n      return(i)\n    }\n  }\n  return(NULL)\n}\n\ngetDebugContent = function(content, question) {\n  debug = concerto.template.join(templateId=item_debug_template,params=list(id=question$id))\n  content = paste0(debug, content)\n  return(content)\n}\n\nupdateSavedState = function(questions, theta, sem, out, time_limit, correctness, current_item){\n  if(!is.null(concerto$promoted$.savedState)) {\n    concerto$promoted$.savedState <<- list()\n  }\n  if(!is.null(concerto$promoted$.savedState$CAT)) {\n    concerto$promoted$.savedState$CAT <<- list()\n  }\n  \n  concerto$promoted$.savedState$CAT$questions <<- questions\n  concerto$promoted$.savedState$CAT$theta <<- theta\n  concerto$promoted$.savedState$CAT$sem <<- sem\n  concerto$promoted$.savedState$CAT$out <<- out\n  concerto$promoted$.savedState$CAT$time_limit <<- time_limit\n  concerto$promoted$.savedState$CAT$correctness <<- correctness\n  concerto$promoted$.savedState$CAT$current_item <<- current_item\n}\n\nsr_time = fromJSON(stopping_time)\nresumed = F\nif(!is.null(concerto$promoted$.savedState) && !is.null(concerto$promoted$.savedState$CAT)) {\n  resumed = T\n  \n  questions = concerto$promoted$.savedState$CAT$questions\n  theta = concerto$promoted$.savedState$CAT$theta\n  sem = concerto$promoted$.savedState$CAT$sem\n  out = concerto$promoted$.savedState$CAT$out\n  time_limit = concerto$promoted$.savedState$CAT$time_limit\n  correctness = concerto$promoted$.savedState$CAT$correctness\n  current_item = concerto$promoted$.savedState$CAT$current_item\n} else {\n  questions = getQuestions()\n  theta = 0\n  sem = 1\n  out = NULL\n  time_limit = 0\n  if(!is.null(sr_time$type) && (sr_time$type == \"test\" || sr_time$type == \"item\")) { time_limit = as.numeric(sr_time$time_limit) }\n  correctness = c()\n  current_item = 1\n}\n\ncb_group = NULL\ncb_control = NULL\ncb = fromJSON(cb)\nprint(cb)\nif(cb$enabled == \"1\") {\n  cb_group = as.character(questions[,9])\n  print(cb_group)\n\n  props_list = NULL\n  if(length(cb$props) > 0) {\n    for(i in 1:length(cb$props)) {\n      props_list = rbind(props_list, as.list(cb$props[[i]]))\n    }\n  } else {\n    stop(\"Missing content balancing settings!\")\n  }\n  cb_control = list(\n    names=as.character(props_list[,1]),\n    props=as.numeric(props_list[,2])\n  )\n  print(cb_control)\n}\nparam_bank = questions[,4:7,drop=F]\nparam_bank = apply(param_bank, 2, as.numeric)\nrb = fromJSON(response_bank)\nresponse = NULL\nwarning_msg = \"\"\ntimer_set = FALSE\nif(time_limit > 0) { timer_set = TRUE }\nbuttons = concerto.template.join(templateId=buttons_template,params=list(label=button_label))\n\nif(item_debug == \"0\" && !resumed) { \n  current_item = nextItem(param_bank, theta=theta, out=out, criterion=next_item_criterion, method=scoring_method, randomesque=randomesque, cbGroup=cb_group, cbControl=cb_control)$item\n}\nwhile(T) {\n  question = questions[current_item,]\n  content = getContent(question)\n\n  if(item_debug == \"0\") {\n    updateSavedState(questions, theta, sem, out, time_limit, correctness, current_item)\n    response = concerto.template.show(decoded_template_def$layout, params=getTemplateParams(list(\n      header=decoded_template_def$header, \n      title=title,\n      content=content, \n      warning_msg=warning_msg, \n      buttons=buttons,\n      footer=decoded_template_def$footer\n    )), timeLimit=time_limit)\n    warning_msg = \"\"\n\n    if(timer_set) {\n      time_limit = time_limit - as.numeric(response$timeTaken)\n    }\n    valid = \"response\" %in% ls(response) && response$response != \"\"\n    if(valid || response$isTimeout == \"1\") {\n      correct = 0\n      if(!is.null(response$response) && response$response == question$correct) { correct = 1 }\n      correctness = c(correctness, correct)\n      out = c(out, current_item)\n      theta <- thetaEst(matrix(param_bank[out,], ncol=4, byrow=F), correctness, method=scoring_method)\n      sem <- semTheta(theta, matrix(param_bank[out,], ncol=4, byrow=F), correctness)\n      saveResponse(response, question, rb, theta, sem, correct)\n      if(shouldStop(response, sem, out, questions)) {\n        if(response$isTimeout == \"1\") {\n          .branch = \"out_of_time\"\n        }\n        break\n      } else {\n        if(timer_set && sr_time$type == \"item\") {\n          time_limit = as.numeric(sr_time$time_limit)\n        }\n        current_item = nextItem(param_bank, theta=theta, out=out, criterion=next_item_criterion, method=scoring_method, randomesque=randomesque, cbGroup=cb_group, cbControl=cb_control)$item\n      }\n    } else {\n      warning_msg = no_answer_alert\n    }\n  } else {\n    content = getDebugContent(content, question)\n    updateSavedState(questions, theta, sem, out, time_limit, correctness, current_item)\n    response = concerto.template.show(decoded_template_def$layout, params=getTemplateParams(list(\n      header=decoded_template_def$header, \n      title=title,\n      content=content, \n      warning_msg=warning_msg, \n      buttons=buttons,\n      footer=decoded_template_def$footer\n    )))\n    current_item = getNextDebugItem(response, questions)\n    if(is.null(current_item)) {\n      warning_msg = paste0(\"Item id \",response$item_debug,\" not found!\")\n      current_item = 1\n    }\n  }\n}\nscore = list(theta=theta, sem=sem)\nrm(questions)\nconcerto$promoted$.savedState$CAT <<- NULL",
            "resumable": "0",
            "outdated": "0",
            "description": "",
            "variables": [
                {
                    "class_name": "TestVariable",
                    "id": 282,
                    "name": "answered",
                    "type": 2,
                    "description": "",
                    "passableThroughUrl": "0",
                    "value": "0",
                    "test": 25,
                    "parentVariable": null
                },
                {
                    "class_name": "TestVariable",
                    "id": 283,
                    "name": "paragraph",
                    "type": 0,
                    "description": "",
                    "passableThroughUrl": "0",
                    "value": null,
                    "test": 25,
                    "parentVariable": null
                },
                {
                    "class_name": "TestVariable",
                    "id": 284,
                    "name": "button_label",
                    "type": 0,
                    "description": "",
                    "passableThroughUrl": "0",
                    "value": null,
                    "test": 25,
                    "parentVariable": null
                },
                {
                    "class_name": "TestVariable",
                    "id": 285,
                    "name": "item_bank",
                    "type": 0,
                    "description": "",
                    "passableThroughUrl": "0",
                    "value": null,
                    "test": 25,
                    "parentVariable": null
                },
                {
                    "class_name": "TestVariable",
                    "id": 286,
                    "name": "response_bank",
                    "type": 0,
                    "description": "",
                    "passableThroughUrl": "0",
                    "value": null,
                    "test": 25,
                    "parentVariable": null
                },
                {
                    "class_name": "TestVariable",
                    "id": 287,
                    "name": "stopping_time",
                    "type": 0,
                    "description": "",
                    "passableThroughUrl": "0",
                    "value": null,
                    "test": 25,
                    "parentVariable": null
                },
                {
                    "class_name": "TestVariable",
                    "id": 288,
                    "name": "stopping_item_count",
                    "type": 0,
                    "description": "",
                    "passableThroughUrl": "0",
                    "value": null,
                    "test": 25,
                    "parentVariable": null
                },
                {
                    "class_name": "TestVariable",
                    "id": 289,
                    "name": "stopping_accuracy",
                    "type": 0,
                    "description": "",
                    "passableThroughUrl": "0",
                    "value": null,
                    "test": 25,
                    "parentVariable": null
                },
                {
                    "class_name": "TestVariable",
                    "id": 290,
                    "name": "scoring_method",
                    "type": 0,
                    "description": "",
                    "passableThroughUrl": "0",
                    "value": null,
                    "test": 25,
                    "parentVariable": null
                },
                {
                    "class_name": "TestVariable",
                    "id": 291,
                    "name": "next_item_criterion",
                    "type": 0,
                    "description": "",
                    "passableThroughUrl": "0",
                    "value": null,
                    "test": 25,
                    "parentVariable": null
                },
                {
                    "class_name": "TestVariable",
                    "id": 292,
                    "name": "randomesque",
                    "type": 0,
                    "description": "",
                    "passableThroughUrl": "0",
                    "value": null,
                    "test": 25,
                    "parentVariable": null
                },
                {
                    "class_name": "TestVariable",
                    "id": 293,
                    "name": "randomize_response_options",
                    "type": 0,
                    "description": "",
                    "passableThroughUrl": "0",
                    "value": null,
                    "test": 25,
                    "parentVariable": null
                },
                {
                    "class_name": "TestVariable",
                    "id": 294,
                    "name": "no_answer_alert",
                    "type": 0,
                    "description": "",
                    "passableThroughUrl": "0",
                    "value": null,
                    "test": 25,
                    "parentVariable": null
                },
                {
                    "class_name": "TestVariable",
                    "id": 295,
                    "name": "session",
                    "type": 0,
                    "description": "",
                    "passableThroughUrl": "0",
                    "value": null,
                    "test": 25,
                    "parentVariable": null
                },
                {
                    "class_name": "TestVariable",
                    "id": 296,
                    "name": "score",
                    "type": 1,
                    "description": "<p>Score R list object with following elements:<\/p>\n\n<ul>\n\t<li><strong>score$theta<\/strong><\/li>\n\t<li><strong>score$sem<\/strong><\/li>\n<\/ul>\n",
                    "passableThroughUrl": "0",
                    "value": null,
                    "test": 25,
                    "parentVariable": null
                },
                {
                    "class_name": "TestVariable",
                    "id": 297,
                    "name": "inserts",
                    "type": 0,
                    "description": "",
                    "passableThroughUrl": "0",
                    "value": null,
                    "test": 25,
                    "parentVariable": null
                },
                {
                    "class_name": "TestVariable",
                    "id": 298,
                    "name": "item_debug",
                    "type": 0,
                    "description": "<p>1 to turn item debug mode on. 0 to turn it off. Item debug mode let&#39;s you specify which item you want to&nbsp;view from your item bank.<\/p>\n",
                    "passableThroughUrl": "0",
                    "value": "0",
                    "test": 25,
                    "parentVariable": null
                },
                {
                    "class_name": "TestVariable",
                    "id": 299,
                    "name": "out_of_time",
                    "type": 2,
                    "description": "",
                    "passableThroughUrl": "0",
                    "value": null,
                    "test": 25,
                    "parentVariable": null
                },
                {
                    "class_name": "TestVariable",
                    "id": 300,
                    "name": "cb",
                    "type": 0,
                    "description": "",
                    "passableThroughUrl": "0",
                    "value": null,
                    "test": 25,
                    "parentVariable": null
                },
                {
                    "class_name": "TestVariable",
                    "id": 301,
                    "name": "title",
                    "type": 0,
                    "description": "",
                    "passableThroughUrl": "0",
                    "value": null,
                    "test": 25,
                    "parentVariable": null
                },
                {
                    "class_name": "TestVariable",
                    "id": 302,
                    "name": "template_def",
                    "type": 0,
                    "description": "",
                    "passableThroughUrl": "0",
                    "value": null,
                    "test": 25,
                    "parentVariable": null
                },
                {
                    "class_name": "TestVariable",
                    "id": 303,
                    "name": "responses_layout",
                    "type": 0,
                    "description": "",
                    "passableThroughUrl": "0",
                    "value": null,
                    "test": 25,
                    "parentVariable": null
                },
                {
                    "class_name": "TestVariable",
                    "id": 304,
                    "name": "response_width",
                    "type": 0,
                    "description": "",
                    "passableThroughUrl": "0",
                    "value": null,
                    "test": 25,
                    "parentVariable": null
                },
                {
                    "class_name": "TestVariable",
                    "id": 305,
                    "name": ".branch",
                    "type": 1,
                    "description": "",
                    "passableThroughUrl": "0",
                    "value": null,
                    "test": 25,
                    "parentVariable": null
                },
                {
                    "class_name": "TestVariable",
                    "id": 306,
                    "name": "CAT_template",
                    "type": 0,
                    "description": "",
                    "passableThroughUrl": "0",
                    "value": null,
                    "test": 25,
                    "parentVariable": null
                },
                {
                    "class_name": "TestVariable",
                    "id": 307,
                    "name": "item_debug_template",
                    "type": 0,
                    "description": "",
                    "passableThroughUrl": "0",
                    "value": null,
                    "test": 25,
                    "parentVariable": null
                },
                {
                    "class_name": "TestVariable",
                    "id": 308,
                    "name": "buttons_template",
                    "type": 0,
                    "description": "",
                    "passableThroughUrl": "0",
                    "value": null,
                    "test": 25,
                    "parentVariable": null
                }
            ],
            "sourceWizard": null,
            "sourceWizardName": null,
            "sourceWizardTest": null,
            "sourceWizardTestName": null,
            "updatedOn": "2017-05-09 16:56:14",
            "updatedBy": "",
            "nodes": [],
            "nodesConnections": [],
            "tags": "",
            "owner": 1,
            "groups": "",
            "starterContent": true,
            "rev": 11,
            "hash": "e6cc6b28ad51952fa2a300fa3b2340ad8c6cb573"
        }
    ]
}